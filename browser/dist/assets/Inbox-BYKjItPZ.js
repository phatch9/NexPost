import{r as i,g as N,j as e,S as d,d as g,u as _,h as C,i as $,L as A,e as m}from"./index-C5ZQxRwH.js";import{m as h,A as k}from"./proxy-DXfvcpxa.js";const x="/default_avatar.png";function F(){const[t,n]=i.useState(!1),{data:r}=N({queryKey:["inbox"],queryFn:async()=>{const s=await m.get("/api/messages/inbox");return Array.isArray(s.data)?s.data:[]}});return i.useEffect(()=>(t?document.title=`Inbox | ${t.username}`:document.title="NexPost | Inbox",()=>{document.title="NexPost"}),[t]),e.jsxs("div",{className:"flex flex-1",children:[!t&&e.jsxs("ul",{className:"md:hidden p-4 m-2.5 space-y-2 list-none bg-white rounded-md w-full",children:[e.jsx("div",{className:"flex justify-between items-center py-3 border-b-2",children:e.jsx("h1",{className:"text-2xl font-semibold text-blue-600",children:"Messages"})}),(r??[]).map(s=>e.jsxs("li",{onClick:()=>n(s.sender),className:`w-full flex items-center p-3 space-x-2 rounded-xl cursor-pointer ${t&&t.username===s.sender.username?"bg-blue-200":"hover:bg-blue-200"}`,children:[e.jsx("img",{src:s.sender.avatar||x,className:"object-cover w-14 h-14 rounded-full",alt:""}),e.jsxs("div",{className:"flex flex-col space-y-1 w-full",children:[e.jsxs("div",{className:"flex justify-between items-center w-full",children:[e.jsx("p",{className:"font-medium",children:s.sender.username}),!s.latest_from_user&&!s.seen&&e.jsx(d,{type:"mail",className:"w-4 h-4 text-theme-orange"})]}),e.jsxs("p",{className:"text-sm",children:[s.latest_from_user?"You: ":`${s.receiver.username}: `,s.content.slice(0,15),s.content.length>15?"...":""]})]})]},s.message_id))]}),e.jsxs("ul",{className:"hidden md:block p-4 w-1/5 m-2.5 space-y-2 list-none bg-white rounded-md",children:[e.jsx("div",{className:"flex justify-between items-center py-3 border-b-2",children:e.jsx("h1",{className:"text-2xl font-semibold text-blue-600",children:"Messages"})}),r?.map((s,c)=>e.jsxs(h.li,{initial:{opacity:0,x:-100},animate:{opacity:1,x:0},transition:{duration:.25,delay:c*.25},onClick:()=>n(s.sender),className:`flex items-center w-full p-3 space-x-2 rounded-xl cursor-pointer ${t&&t.username===s.sender.username?"bg-blue-200":"hover:bg-blue-200"}`,children:[e.jsx("img",{src:s.sender.avatar||x,className:"object-cover w-14 h-14 rounded-full",alt:""}),e.jsxs("div",{className:"flex flex-col space-y-1 w-full",children:[e.jsxs("div",{className:"flex justify-between items-center w-full",children:[e.jsx("p",{className:"font-medium",children:s.sender.username}),!s.latest_from_user&&!s.seen&&e.jsx(d,{type:"mail",className:"w-4 h-4 text-theme-orange"})]}),e.jsxs("p",{className:"text-sm",children:[s.latest_from_user?"You: ":`${s.receiver.username}: `,s.content.slice(0,15),s.content.length>15?"...":""]})]})]},s.message_id))]}),e.jsx(k,{children:t&&e.jsx("div",{className:"flex-1 m-2.5 bg-white rounded-md",children:e.jsx(S,{sender:t,setCurChat:n})})})]})}function S({sender:t,setCurChat:n,newChat:r=!1}){const s=i.useRef(null),c=g(),{user:v}=_(),[o,f]=i.useState(""),{data:p,isFetching:b}=N({queryKey:["chat",t.username],queryFn:async()=>(await m.get(`/api/messages/all/${t.username}`)).data,enabled:!!t.username}),{mutate:j}=C({mutationFn:async a=>(await m.post("/api/messages",{content:a.message,receiver:a.sender.username})).data,onSuccess:a=>{f(""),c.setQueryData(["chat",t.username],(l=[])=>[...l,a]),c.setQueryData(["inbox"],(l=[])=>l.map(u=>u.sender.username===t.username?{...u,content:a.content,created_at:a.created_at,message_id:a.message_id}:u))}});i.useEffect(()=>{s.current?.scrollIntoView({behavior:"smooth"})},[b]);const y=(p?.length??0)-10,w={hidden:{opacity:0,x:10},visible:{opacity:1,x:0}};return e.jsxs(h.div,{className:`flex flex-col justify-between w-full ${r&&"bg-white w-10/12 md:w-1/2"}`,variants:w,initial:"hidden",animate:"visible",exit:{opacity:0,x:10,transition:{duration:.1}},transition:{duration:.25},children:[e.jsxs("div",{className:"flex justify-between items-center p-3 mx-2 border-b-2",children:[e.jsxs("div",{className:"flex items-center space-x-4",children:[e.jsx("img",{src:t.avatar||x,alt:"",className:"object-cover w-14 h-14 rounded-full"}),e.jsx($,{to:`/u/${t.username}`,className:"text-xl font-semibold text-blue-500",children:t.username})]}),e.jsx("button",{onClick:()=>n(!1),className:"p-2 ml-auto text-white bg-blue-600 rounded-md",children:"Close"})]}),b?e.jsx("div",{className:"flex justify-center items-center md:h-[61vh] h-[70vh]",children:e.jsx(A,{forPosts:!0})}):e.jsxs("ul",{className:"p-3 space-y-3 rounded-md overflow-auto md:h-[61vh] h-[70vh]",children:[p?.map((a,l)=>e.jsx(D,{message:a,toUser:a.sender.username===v.username,messageIndex:l<y?0:l-y},a.message_id)),e.jsx("li",{className:"invisible",ref:s})]}),e.jsxs("form",{onSubmit:a=>{a.preventDefault(),j({message:o,sender:t})},className:"flex justify-between items-center p-4 w-full bg-blue-200",children:[e.jsx("input",{type:"text",className:"p-2 px-4 mx-3 w-full font-medium rounded-full focus:outline-none",placeholder:"Type a message",value:o,onChange:a=>f(a.target.value)}),e.jsx(d,{onClick:()=>j({message:o,sender:t}),type:"send",className:"w-8 h-8 text-white"})]})]})}function D({message:t,toUser:n,messageIndex:r}){const s=new Date(t.created_at);return e.jsxs(h.li,{initial:{opacity:0,x:n?100:-100},animate:{opacity:1,x:0},transition:{duration:.25,delay:r*.1},className:`pl-2 py-1 w-fit rounded-md ${t.seen?"bg-green-100":"bg-blue-100"} ${n?"ml-auto pr-2":"pr-10"}`,children:[e.jsx("p",{className:`break-all pt-1 font-medium ${n&&"pl-1"}`,children:t.content}),e.jsx("p",{className:`mt-0.5 text-xs font-light ${n&&"text-right"}`,children:s.toLocaleString()})]})}export{S as Chat,F as Inbox,F as default};
